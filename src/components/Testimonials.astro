---
interface Testimonial {
  quote: string;
  author: string;
  role: string;
  location: string;
  image?: string;
}

const testimonials: Testimonial[] = [
  {
    quote: "Die Planung der neuen Fachräume war hochprofessionell. TRIAS hat unsere pädagogischen Konzepte perfekt in Möbel übersetzt.",
    author: "Dr. Markus Innerhofer",
    role: "Schuldirektor",
    location: "Bozen",
  },
  {
    quote: "Besonders beeindruckt hat uns die saubere Montage während der Sommerferien. Pünktlich zum Schulstart war alles bereit.",
    author: "Elena Perkmann",
    role: "Vizedirektorin",
    location: "Meran",
  },
  {
    quote: "Ergonomie, die man spürt. Unsere Schüler sitzen konzentrierter, und das Design wertet das gesamte Schulgebäude auf.",
    author: "Ing. Stefan Holzer",
    role: "Gemeindetechniker",
    location: "Brixen",
  }
];
---

<section class="py-24 bg-slate-50 overflow-hidden">
  <div class="max-w-7xl mx-auto px-6">
    <div class="flex flex-col md:flex-row md:items-end justify-between mb-16 gap-6">
      <div class="max-w-2xl">
        <h2 class="text-4xl font-extrabold text-trias-navy tracking-tight mb-4">
          Was unsere <span class="text-trias-power">Partner</span> sagen.
        </h2>
        <p class="text-slate-500 text-lg">Vertrauen aus über 500 Projekten in ganz Südtirol.</p>
      </div>
      
      <div class="hidden md:flex gap-4">
        <button id="prev-test" class="p-4 rounded-full border border-slate-200 hover:bg-white hover:shadow-lg transition-all">
          <svg class="w-6 h-6 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
        <button id="next-test" class="p-4 rounded-full bg-trias-navy text-white hover:bg-trias-power transition-all shadow-xl shadow-blue-900/10">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>
    </div>

    <div id="testimonial-container" class="flex overflow-x-auto snap-x snap-mandatory gap-6 pb-5 pr-8 md:pr-0 hide-scrollbar scroll-smooth">
      {testimonials.map((t, index) => (
        <div
          data-testimonial-card
          class="snap-start shrink-0 w-[82%] sm:w-[70%] md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] bg-white p-10 rounded-trias shadow-sm border border-slate-100 flex flex-col justify-between"
        >
          <div>
            <svg class="w-10 h-10 text-trias-power/20 mb-6" fill="currentColor" viewBox="0 0 32 32">
              <path d="M10 8v8h6v1h-3c-3.314 0-6 2.686-6 6s2.686 6 6 6 6-2.686 6-6v-15h-9zM24 8v8h6v1h-3c-3.314 0-6 2.686-6 6s2.686 6 6 6 6-2.686 6-6v-15h-9z"></path>
            </svg>
            <p class="text-xl text-trias-navy leading-relaxed font-medium italic mb-8">
              "{t.quote}"
            </p>
          </div>
          
          <div class="flex items-center gap-4 border-t border-slate-50 pt-6">
            <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center text-trias-navy font-bold">
              {t.author.charAt(0)}
            </div>
            <div>
              <div class="font-bold text-trias-navy">{t.author}</div>
              <div class="text-sm text-slate-400">{t.role} — {t.location}</div>
            </div>
          </div>
        </div>
      ))}
    </div>

    <div class="md:hidden mt-2 flex items-center">
      <div id="testimonial-dots" class="flex items-center gap-2">
        {testimonials.map((_, index) => (
          <button
            type="button"
            class={`testimonial-dot h-2.5 rounded-full transition-all ${index === 0 ? 'w-6 bg-trias-power' : 'w-2.5 bg-slate-300'}`}
            data-index={index}
            aria-label={`Referenz ${index + 1}`}
          />
        ))}
      </div>
    </div>
  </div>
</section>

<style>
  .hide-scrollbar::-webkit-scrollbar { display: none; }
  .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<script>
  function initTestimonials() {
    const container = document.getElementById('testimonial-container');
    const nextBtn = document.getElementById('next-test');
    const prevBtn = document.getElementById('prev-test');
    const dots = Array.from(document.querySelectorAll('.testimonial-dot'));
    const cards = container ? Array.from(container.querySelectorAll('[data-testimonial-card]')) : [];

    const setActiveDot = (activeIndex) => {
      dots.forEach((dot, index) => {
        dot.classList.toggle('w-6', index === activeIndex);
        dot.classList.toggle('bg-trias-power', index === activeIndex);
        dot.classList.toggle('w-2.5', index !== activeIndex);
        dot.classList.toggle('bg-slate-300', index !== activeIndex);
      });
    };

    const updateActiveFromScroll = () => {
      if (!container || cards.length === 0) return;
      let activeIndex = 0;
      let minDistance = Number.POSITIVE_INFINITY;

      cards.forEach((card, index) => {
        const distance = Math.abs(card.offsetLeft - container.scrollLeft);
        if (distance < minDistance) {
          minDistance = distance;
          activeIndex = index;
        }
      });

      setActiveDot(activeIndex);
    };

    if (container && nextBtn && prevBtn) {
      nextBtn.addEventListener('click', () => {
        container.scrollLeft += container.offsetWidth / 2;
      });
      prevBtn.addEventListener('click', () => {
        container.scrollLeft -= container.offsetWidth / 2;
      });
    }

    if (container && cards.length > 0 && dots.length > 0) {
      container.addEventListener('scroll', updateActiveFromScroll, { passive: true });

      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const index = Number(dot.getAttribute('data-index'));
          const target = cards[index];
          if (!target) return;
          container.scrollTo({ left: target.offsetLeft, behavior: 'smooth' });
        });
      });

      updateActiveFromScroll();
    }
  }
  initTestimonials();
  document.addEventListener('astro:after-swap', initTestimonials);
</script>
